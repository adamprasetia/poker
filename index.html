<!DOCTYPE html> 
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">        
        <link rel="stylesheet" href="assets/css/style.css?v=2018-03-27-06-03">        
        <title>Cianjur Poker</title>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115449429-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-115449429-1');
        </script>
    </head>
    <body>
        <div class="container-fluids">            
            <div class="card text-white bg-dark">
                <div class="card-body">
                    <div id="status"></div>                
                    <fb:login-button id="fb-login" scope="public_profile,email"></fb:login-button>
                </div>
            </div>                
            <div class="card text-white bg-dark">
            <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="card text-white bg-dark">
                        <div class="card-bodys">
                            <img src="assets/img/table.png" class="img-fluid img-thumbnail">
                            <div class="player-wrap"></div>
                            <div id="tablecard"></div>
                            <button type="button" name="button" class="btn btn-sm btn-secondary sit sit-1" data-value="1" style="display:none">Duduk</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary sit sit-2" data-value="2" style="display:none">Duduk</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary sit sit-3" data-value="3" style="display:none">Duduk</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary sit sit-4" data-value="4" style="display:none">Duduk</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary sit sit-5" data-value="5" style="display:none">Duduk</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary sit sit-6" data-value="6" style="display:none">Duduk</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary sit sit-7" data-value="7" style="display:none">Duduk</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary sit sit-8" data-value="8" style="display:none">Duduk</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary sit sit-9" data-value="9" style="display:none">Duduk</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary sit sit-10" data-value="10" style="display:none">Duduk</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary stand-up" style="display:none">Berdiri</button>
                            <button id="btn-pas" type="button" name="button" class="btn btn-lg btn-danger" style="display:none">Pas</button>
                            <button id="btn-send" type="button" name="button" class="btn btn-lg btn-success" style="display:none">Ikut</button>
                        </div>
                    </div>                
                    <div class="card text-white bg-dark">
                        <div id="mecard" class="card-bodys clearfix">
                            
                        </div>
                    </div>
                    <div class="card text-white bg-dark admin" style="display:none">
                        <div class="card-body">
                            <button type="button" name="button" class="btn btn-sm btn-secondary reset" onclick="resetGame()">Reset</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary reset" onclick="addBot()">Add Bot</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary reset" onclick="removeBot()">Remove Bot</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary reset" onclick="changeGiliran()">Change Giliran</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary reset" onclick="setPasGiliran()">Pas</button>
                            <button type="button" name="button" class="btn btn-sm btn-secondary reset" onclick="setStandUpGiliran()">Stand Up</button>
                        </div>
                    </div>        
                </div>
                <div class="col-md-4">                
                    <div class="card text-white bg-dark">
                        <div class="card-header">
                            Chat
                        </div>
                        <div id="chat-body" class="card-body">
                            
                        </div>
                        <div class="card-footer">
                            <div class="input-group">
                                <input id="input-chat" type="text" class="form-control" placeholder="Enter chat ...">
                                <div class="input-group-append">
                                    <button id="btn-chat" class="btn btn-primary" type="button">Send</button>
                                </div>
                            </div>                    
                        </div>
                    </div>      
                </div>
            </div>
            </div>
            </div>
        </div>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>        
        <script type="text/javascript" src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
        <script type="text/javascript" src="assets/js/helper.js?v=2018-12-20-15-10"></script>
        <script type="text/javascript" src="assets/js/firebase.js?v=2018-03-23-16-45"></script>
        <script src="//connect.facebook.net/en_US/sdk.js"></script>
        <script type="text/javascript" src="assets/js/facebook.js?v=2018-03-23-18-37"></script>
        <!-- <script src="https://code.responsivevoice.org/responsivevoice.js"></script> -->
        <script type="text/javascript">
            var room = getRoom();
            var me;
            var timeout = 100;
            var cardSelected = [];
            
            // admin
            if (getParameterByName('admin')=='sempakbolong') {
                $('.admin').show();
            }

            // chat 
            firebase.database().ref(room+'/chat').on('value', function(response) {
                firebase.database().ref(room+'/giliran').once('value', function(responseGiliran) {                    
                    if (responseGiliran.val() && typeof me !== 'undefined' && responseGiliran.val() == me.id) {                    
                        responsiveVoice.speak(response.val().message, "Indonesian Female");
                    }                
                });
                if (response.val() && typeof response.val() !== 'undefined') {
                    $('#chat-body').append('<p><span class="badge badge-secondary">'+response.val().from+'</span> '+encodeHTML(response.val().message)+'</p>');
                    $('#chat-body').scrollTop($('#chat-body')[0].scrollHeight);
                }
            });

            firebase.database().ref(room).on('value', function(response) {
                if (response.val()) {                    
                    var giliran = response.val().giliran
                    if (me && giliran == me.id) {
                        $('#btn-send').show();
                        $('#btn-pas').show();
                    }else{
                        $('#btn-send').hide();
                        $('#btn-pas').hide();                    
                    }
                    showPlayer(response.val(), function(){
                        
                    });
                }
            });

            $('.sit').click(function(){
                if (me && me.id && typeof me !== 'undefined') {                    
                    setSit(me.id, $(this).attr('data-value'), function(){
                        checkReset();
                    });
                }else{
                    swal("Oops", "Maaf, Silahkan login terlebih dahulu" , "error");
                }
            });
            $('.stand-up').click(function(){
                setStandUp(me.id, function(){
                    checkReset();
                });
            });

            $('body').on('click','.kartu',function(){
                cardSelected = [];
                $(this).toggleClass('active');
                $.each($('body').find('.kartu.active'), function(index, value) {
                    cardSelected.push(parseInt(value.getAttribute('data-value')));
                });
            });
            $('#btn-send').click(function(){
                $(this).prop('disabled', true);
                firebase.database().ref(room).once('value').then(function(response){                   
                    var players = response.val().player;
                    var tablecard = JSON.parse(response.val().tablecard);
                    var myCard = JSON.parse(players[me.id].card);
                    var uniqueCardSelected = [];
                    $.each(cardSelected, function(i, el){
                        if($.inArray(el, uniqueCardSelected) === -1 && el <= 51 && el >= 0 && $.inArray(el, myCard) !== -1) uniqueCardSelected.push(el);
                    });
                    if (checkGiliran()) {   
                        if (validasi(uniqueCardSelected, tablecard)) {
                            sendCard(uniqueCardSelected, function(){
                                $('#btn-send').prop('disabled', false);
                            });
                        }else{
                            swal("Oops", "Maaf, Kartu anda lebih kecil atau tidak termasuk bagian (pair, fullhouse, straight, flush)" , "error");
                            $('#btn-send').prop('disabled', false);                                                    
                        }
                    }else{
                        swal("Oops", "Maaf, Bukan giliran anda" , "error");
                        $('#btn-send').prop('disabled', false);                        
                    }
                });
            });
            $('#btn-pas').click(function(){
                $(this).prop('disabled', true);
                setPas(me.id, function(){
                    
                });
            });
            $('#btn-chat').click(function(){
                sendChat();
            });
            $('#input-chat').on('keyup', function (e) {
                if (e.keyCode == 13) {
                    sendChat();
                }
            });              
            function setPasGiliran(){
                firebase.database().ref(room).once('value').then(function(response){
                    setPas(response.val().giliran);
                });
            }
            function setStandUpGiliran(){
                firebase.database().ref(room).once('value').then(function(response){
                    setStandUp(response.val().giliran);
                });
            }

        </script>
    </body>
</html>