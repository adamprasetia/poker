<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Poker</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <link rel="stylesheet" href="assets/css/style.css?v=2018.03.09.10.15">
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115449429-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'UA-115449429-1');
        </script>        
    </head>
    <body>
        <img src="assets/img/poker_table_green.png?v=2018.03.07.11.47" alt="">
        <div id="tablecard" style="width:300px"></div>
        <div class="tablesit" style="display:none">     
            <div class="sit-1 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="1">
                    Duduk
                </a>
            </div>       
            <div class="sit-2 sitwrap">
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="2">
                    Duduk
                </a>
            </div>       
            <div class="sit-3 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="3">
                    Duduk
                </a>
            </div>       
            <div class="sit-4 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="4">
                    Duduk
                </a>
            </div>       
            <div class="sit-5 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="5">
                    Duduk
                </a>
            </div>       
            <div class="sit-6 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="6">
                    Duduk
                </a>
            </div>       
            <div class="sit-7 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="7">
                    Duduk
                </a>
            </div>       
            <div class="sit-8 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="8">
                    Duduk
                </a>
            </div>       
            <div class="sit-9 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="9">
                    Duduk
                </a>
            </div>       
            <div class="sit-10 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="10">
                    Duduk
                </a>
            </div>       
        </div>
        <div class="playersit"></div>
        <div class="button-close">
            <button id="btn-standup" type="button" name="button" class="btn btn-sm btn-secondary" disabled="true">Berdiri</button>
            <!-- <button id="btn-reset" type="button" name="button" class="btn btn-sm btn-danger" onclick="resetGame()">Reset Game</button> -->
        </div>
        <div class="chat">
            <div class="card text-white bg-dark">
                <div class="card-header">
                    Chat
                </div>
                <div id="chat-body" class="card-body">
                    
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input id="input-chat" type="text" class="form-control" placeholder="Enter chat ...">
                        <div class="input-group-append">
                            <button id="btn-chat" class="btn btn-primary" type="button">Send</button>
                        </div>
                    </div>                    
                </div>
            </div>
        </div>
        <div class="login">            
            <div class="card text-white bg-dark">
                <div class="card-body">
                    <fb:login-button scope="public_profile,email" onlogin="checkLoginState();"></fb:login-button>
                    <div id="status"></div>                
                </div>
            </div>
        </div>
        <div class="button-play">            
            <button id="btn-pas" type="button" name="button" class="btn btn-lg btn-danger">Pas</button>
            <button id="btn-send" type="button" name="button" class="btn btn-lg btn-success">Ikut</button>
        </div>
        <div class="mecard">
            <div class="card text-white bg-dark">
                <div id="mecard" class="card-body">

                </div>
            </div>
        </div>
        <div class="room">
            <div class="card text-white bg-dark">
                <div class="card-body">
                    <label for="">Room</label>
                    <div class="form-group">
                        <input id="room-name" type="text" name="" value="" class="form-control">
                    </div>
                    <button id="join-room" type="button" name="button" class="btn btn-primary">Ikut Gabung</button>
                </div>
            </div>            
        </div>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
        <script src="assets/js/config.js"></script>
        <script src="assets/js/helper.js?v=2018.03.09.16.43"></script>
        <script src="assets/js/facebook.js"></script>
        <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
        <script type="text/javascript">
            var room = getParameterByName('room');
            if (!room) {
                room = 'games';
            }
            var me = '';
            var cardSelected = [];
            var timeout = 100;

            // timer
            setInterval(function(){
                if (timeout==0) {
                    timeout = 100;
                    kickPlayer();
                }
                timeout--;
                $('body').find('.progress-bar').attr('style','width: '+timeout+'%');
            },1000);
            
            // chat 
            firebase.database().ref(room+'/chat').on('value', function(response) {
                if (response.val() && typeof response.val() !== 'undefined') {
                    $('#chat-body').append('<p><span class="badge badge-secondary">'+response.val().from+'</span> '+response.val().message+'</p>');
                    $('#chat-body').scrollTop($('#chat-body')[0].scrollHeight);
                }
            });
            firebase.database().ref(room+'/player').on('value', function(response) {                
                timeout = 100;
            });
            
            // Main Utama
            firebase.database().ref(room).on('value', function(response) {   
                if (response.val().giliran == me.id) {                    
                    responsiveVoice.speak("Diem Diem Bae, Jalan Coy", "Indonesian Female");
                }

                // check button play
                if (response.val() && response.val().giliran == me.id && response.val().player[me.id].status == 'play') {
                    $('.button-play').show();
                }else{
                    $('.button-play').hide();
                }

                // show tablecard
                if (response.val() && response.val().tablecard) {
                    var tablecard = '';
                    $.each(JSON.parse(response.val().tablecard), function(index, value) {
                        tablecard += '<img class="tablecard img-thumbnail" src="assets/img/'+value+'.png">';
                    });
                    $('#tablecard').html(tablecard);
                }
                // show player
                if (response.val() && response.val().player) {
                    $('.playersit').html('');
                    $('.tablesit').show();
                    $('.tablesit > .sitwrap').show();
                    $('#btn-standup').prop('disabled', true);
                    var mahkota = '';
                    var mecard = '';
                    $.each(response.val().player, function(indexPlayer, valuePlayer) {
                        if (response.val().juara == valuePlayer.id) {
                            mahkota = '<div class="card-header"><img class="img-fluid" src="assets/img/mahkota.png"></div>';
                            mahkota += '<div class="piala" style="position:absolute;left:-40px;top:-5px"><img class="img-fluid" src="assets/img/piala.png"></div>';
                        }else if(response.val().loser == valuePlayer.id){
                            mahkota = '<div class="card-header"><img class="img-fluid" src="assets/img/loser.jpg"></div>';
                            mahkota += '<div class="anting" style="position:absolute;left:-40px"><img class="img-fluid" src="assets/img/anting.png"></div>';
                        }else{
                            mahkota = '';
                        }
                        var giliran = 'bg-dark';
                        var status = '<span class="badge badge-secondary">'+valuePlayer.status+'</span>';
                        if (response.val().giliran && response.val().giliran == valuePlayer.id) {
                            giliran = 'bg-warning';
                        }
                        var playercard = '<div class="playercard">';
                        var kartuSelected = '';
                        if (valuePlayer.card) {    
                            $.each(JSON.parse(valuePlayer.card).sort(function(a, b){return a - b}), function(indexCard, valueCard) {
                                kartuSelected = '';
                                if (cardSelected.length > 0){                                    
                                    if (cardSelected.indexOf(valueCard)!= -1) {
                                        kartuSelected = 'active';
                                    }
                                }
                                if (valuePlayer.id == me.id) {                                          
                                    mecard += '<a href="javascript:void(0)" class="kartu '+kartuSelected+'" data-index="'+indexCard+'" data-value="'+valueCard+'"><img class="card img-thumbnail" src="assets/img/'+valueCard+'.png"></a>';
                                    playercard += '<img class="card img-thumbnail" src="assets/img/back.png">';
                                }else{                                    
                                    playercard += '<img class="card img-thumbnail" src="assets/img/back.png">';
                                }                                                       
                            });
                        }
                        playercard += '</div>';
                        if (valuePlayer.sitno) {         
                            $('.tablesit > .sit-'+valuePlayer.sitno).hide();
                            var waktu = '<div class="card-footer"><div class="progress" style="height: 5px;"><div style="width: 100%;" class="progress-bar" role="progressbar" aria-valuenow="" aria-valuemin="0" aria-valuemax="100"></div></div></div>';
                            if (response.val().giliran && response.val().giliran != valuePlayer.id) {
                                waktu = '';
                            }
                            $('.playersit').append('<div class="sit-'+valuePlayer.sitno+' sitwrap"><div class="card-custom card text-white '+giliran+'">'+mahkota+'<div class="card-header">'+valuePlayer.name+'</div><div class="card-body"><img class="img-thumbnail img-fluid" src="'+valuePlayer.picture+'"></div>'+waktu+'<div class="card-status">'+valuePlayer.status+'</div>'+playercard+'</div></div></div>');
                        }
                        if (valuePlayer.id == me.id && valuePlayer.sitno && valuePlayer.sitno != 0) {
                            $('.tablesit').hide();
                            $('#btn-standup').prop('disabled', false);
                        }
                    });

                    $('#mecard').html(mecard);
                }
            });
            $('.sit').click(function(){
                var posisi = $(this).attr('data-index');
                if (typeof me.id !== 'undefined') {                    
                    if (checkSitAvailable(parseInt(posisi))) {
                        firebase.database().ref(room+'/player/'+me.id).update({
                            sitno:posisi,
                            status:'waiting'
                        }).then(function(){
                            checkReset();
                        });
                    }else{
                        swal("Oops", "Kursi ini udh ada yg nempatin woyyy!" , "error");
                    }
                }else{
                    swal("Oops", "Login dulu coy, pake facebook!" , "error");
                }
            });
            $('body').on('click','#btn-standup',function(){
                firebase.database().ref(room).once('value').then(function(response){
                    if (response.val().giliran == me.id) {       
                        changeGiliran(function(){
                            firebase.database().ref(room+'/player/'+me.id).update({
                                sitno:0,
                                card:'[]',
                                status:0
                            }).then(function(){                            
                                checkReset();
                            });                                                
                        });
                    }else{
                        firebase.database().ref(room+'/player/'+me.id).update({
                            sitno:0,
                            card:'[]',
                            status:0
                        }).then(function(){                            
                            checkReset();
                        });                                                
                    }
                });
            });

            $('body').on('click','#btn-send',function(){
                $(this).prop('disabled', true);
                firebase.database().ref(room).once('value').then(function(response){                    
                    var myCard = JSON.parse(response.val().player[me.id].card);
                    var uniqueCardSelected = [];
                    $.each(cardSelected, function(i, el){
                        if($.inArray(el, uniqueCardSelected) === -1 && el <= 51 && el >= 0 && $.inArray(el, myCard) !== -1) uniqueCardSelected.push(el);
                    });
                    if (checkGiliran()) {
                        if (validasi(uniqueCardSelected, JSON.parse(response.val().tablecard))) {
                            firebase.database().ref(room).update({
                                tablecard:JSON.stringify(uniqueCardSelected)
                            }).then(function(){
                                $.each(uniqueCardSelected, function(index, value) {
                                    remove(myCard, value);
                                });
                                firebase.database().ref(room+'/player/'+me.id).update({
                                    card:JSON.stringify(myCard)
                                }).then(function(){   
                                    if (response.val().warisan && response.val().warisan != 0 && typeof response.val().warisan != 'undefined') {
                                        firebase.database().ref(room).update({
                                            warisan:0
                                        });      
                                    }
                                    if (myCard.length == 0) {
                                        firebase.database().ref(room+'/player/'+me.id).update({
                                            status:'winner'
                                        }).then(function(){
                                            setWarisan(me.id);
                                            if (response.val().winner == 0 || typeof response.val().winner === 'undefined') {
                                                firebase.database().ref(room).update({
                                                    winner:me.id,
                                                    juara:me.id
                                                }).then(function(){
                                                    checkReset();
                                                });
                                            }else{
                                                checkReset();                                                
                                            }
                                        });
                                    }
                                    changeGiliran(function(){});
                                    cardSelected = [];
                                    $('#btn-send').prop('disabled', false);
                                });                    
                            });                    
                        }else{
                            swal("Oops", "GAK BISAAA WOYYY!" , "error");
                            $('#btn-send').prop('disabled', false);
                        }
                    }else{
                        swal("Oops", "Bukan giliran lu coy!" , "error");
                        $('#btn-send').prop('disabled', false);
                    }
                });
            });            
            $('body').on('click','#btn-pas',function(){
                $(this).prop('disabled', true);
                firebase.database().ref(room).once('value').then(function(response){
                    if (checkGiliran()) {
                        firebase.database().ref(room+'/player/'+me.id).update({
                            status: 'pas'
                        }).then(function(){          
                            setLoserByBom(response.val().player, response.val().bom, function(){                                
                                changeGiliran(function(){});
                                $('#btn-pas').prop('disabled', false);
                                checkReset();
                            });
                        });
                    }else{
                        swal("Oops", "Bukan giliran lu coy!" , "error");
                        $('#btn-pas').prop('disabled', false);
                    }
                });
            });            
            $('body').on('click','.kartu',function(){
                cardSelected = [];
                $(this).toggleClass('active');
                $.each($('body').find('.kartu.active'), function(index, value) {
                    cardSelected.push(parseInt(value.getAttribute('data-value')));
                });
            });
            function sendChat(){
                if (typeof me.name !== 'undefined') {                    
                    firebase.database().ref(room+'/chat').update({
                        message:$('#input-chat').val(),
                        from:me.name
                    }).then(function(){                    
                        $('#input-chat').val('');
                    });                                                                
                }else{
                    swal("Oops", "Mau ngechat ya login dulu dong coy!" , "error");
                }
            }
            $('#btn-chat').click(function(){
                sendChat();
            });
            $('#input-chat').on('keyup', function (e) {
                if (e.keyCode == 13) {
                    sendChat();
                }
            });  
            $('#join-room').click(function(){
                if ($('#room-name').val() != '') {
                    window.location = '?room='+$('#room-name').val();
                }else{
                    swal("Oops", "Isi dulu dong nama room nya coy!" , "error");
                }
            })
        </script>
    </body>
</html>