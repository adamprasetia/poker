<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Poker</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <link rel="stylesheet" href="assets/css/style.css">
    </head>
    <body>
        <img src="assets/img/poker_table_green.png" alt="">
        <div id="tablecard" style="width:300px"></div>
        <div class="tablesit" style="display:none">     
            <div class="sit-1 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="1">
                    Duduk
                </a>
            </div>       
            <div class="sit-2 sitwrap">
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="2">
                    Duduk
                </a>
            </div>       
            <div class="sit-3 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="3">
                    Duduk
                </a>
            </div>       
            <div class="sit-4 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="4">
                    Duduk
                </a>
            </div>       
            <div class="sit-5 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="5">
                    Duduk
                </a>
            </div>       
            <div class="sit-6 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="6">
                    Duduk
                </a>
            </div>       
            <div class="sit-7 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="7">
                    Duduk
                </a>
            </div>       
            <div class="sit-8 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="8">
                    Duduk
                </a>
            </div>       
        </div>
        <div class="playersit"></div>
        
        <div class="button button-play" style="width:200px;display:none">            
            <button id="btn-pas" type="button" name="button" class="btn btn-sm btn-warning">Pas</button>
            <button id="btn-send" type="button" name="button" class="btn btn-sm btn-primary">Send</button>
        </div>
        <div class="button-close">
            <button id="btn-keluar" type="button" name="button" class="btn btn-sm btn-danger">Keluar</button>
            <button id="btn-standup" type="button" name="button" class="btn btn-sm btn-danger">Stand Up</button>
            <!-- <button id="btn-reset" type="button" name="button" class="btn btn-sm btn-danger" onclick="resetGame()">Reset Game</button> -->
        </div>
        <p>Copyright 2018 Sempak Bolong. All rights reserved.</p>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
        <script src="assets/js/config.js"></script>
        <script src="assets/js/helper.js?v=2018.03.05.14.01"></script>
        <script type="text/javascript">
            var userlogin = JSON.parse(getCookie("userlogin"));
            var me = userlogin.username;
            var cardSelected = [];
            var myCard;
            var environment = 'production';
            // var environment = 'development';

            if (!getCookie('userlogin')) {
                window.location = 'index.html';
            }        

            // timer
            setInterval(function(){
                firebase.database().ref('games').once('value', function(response) {
                    if (typeof response.val().waktu !== 'undefined' && parseInt(response.val().waktu) != 0 && response.val().giliran == me) {
                        var waktu = parseInt(response.val().waktu)-1;
                        firebase.database().ref('games').update({
                            waktu:waktu
                        }).then(function(){
                            if (waktu == 0) {
                                firebase.database().ref('games').update({
                                    waktu:100
                                }).then(function(){
                                    console.log('kickPlayer');
                                    console.log('waktu kickPlayer', waktu);
                                    kickPlayer();
                                });
                            }
                        });
                        console.log('waktu', response.val().waktu);
                    }
                });
            },1000);
            
            // Main Utama
            firebase.database().ref('games').on('value', function(response) {
                // check button play
                if (response.val().giliran == me || environment=='development') {
                    $('.button-play').show();
                }else{
                    $('.button-play').hide();
                }
                // for development
                if (environment=='development') {                    
                    myCard = JSON.parse(response.val().player[response.val().giliran].card);
                }else{
                    myCard = JSON.parse(response.val().player[me].card);
                }
                
                var winner = '';
                if (response.val().winner != 0 || typeof response.val().winner != 'undefined') {                    
                    winner = response.val().winner;
                }
                if (response.val().giliran == me) {                    
                    checkReset(response.val().player, winner);
                }
                // show tablecard
                if (response.val().tablecard) {
                    var tablecard = '';
                    $.each(JSON.parse(response.val().tablecard), function(index, value) {
                        tablecard += '<img class="card img-thumbnail" src="assets/img/'+value+'.png">';
                    });
                    $('#tablecard').html(tablecard);
                }
                // show player
                if (response.val().player) {
                    $('.playersit').html('');
                    $('.tablesit').show();
                    $('.tablesit > .sitwrap').show();
                    $('#btn-standup').prop('disabled', true);
                    $.each(response.val().player, function(indexPlayer, valuePlayer) {
                        var giliran = 'badge-secondary';
                        var status = '<span class="badge badge-secondary">'+valuePlayer.status+'</span>';
                        if (response.val().giliran == valuePlayer.name) {
                            giliran = 'badge-warning';
                        }
                        var playercard = '<div class="playercard">';
                        var kartuSelected = '';
                        if (valuePlayer.card) {    
                            $.each(JSON.parse(valuePlayer.card).sort(function(a, b){return a - b}), function(indexCard, valueCard) {
                                kartuSelected = '';
                                if (cardSelected.length > 0){                                    
                                    if (cardSelected.indexOf(valueCard)!= -1) {
                                        kartuSelected = 'active';
                                    }
                                }
                                // for development
                                if (environment == 'development') {                                    
                                    playercard += '<a href="javascript:void(0)" class="kartu '+kartuSelected+'" data-index="'+indexCard+'" data-value="'+valueCard+'"><img class="card img-thumbnail" src="assets/img/'+valueCard+'.png"></a>';
                                }else{
                                    if (valuePlayer.name == me) {                                          
                                        playercard += '<a href="javascript:void(0)" class="kartu '+kartuSelected+'" data-index="'+indexCard+'" data-value="'+valueCard+'"><img class="card img-thumbnail" src="assets/img/'+valueCard+'.png"></a>';
                                    }else{                                    
                                        playercard += '<img class="card img-thumbnail" src="assets/img/back.png">';
                                    }                                                       
                                }
                            });
                        }
                        playercard += '</div>';
                        if (valuePlayer.sitno) {         
                            $('.tablesit > .sit-'+valuePlayer.sitno).hide();
                            var waktu = '<div class="progress"><div style="width: '+response.val().waktu+'%;" class="progress-bar" role="progressbar" aria-valuenow="'+response.val().waktu+'" aria-valuemin="0" aria-valuemax="100"></div></div>';
                            if (response.val().giliran != valuePlayer.name) {
                                waktu = '';
                            }
                            $('.playersit').append('<div class="sit-'+valuePlayer.sitno+' sitwrap"><span class="badge '+giliran+'">'+valuePlayer.name+'-'+valuePlayer.status+'</span>'+waktu+playercard+'</div>');
                        }
                        if (valuePlayer.name == me && valuePlayer.sitno && valuePlayer.sitno != 0) {
                            $('.tablesit').hide();
                            $('#btn-standup').prop('disabled', false);
                        }
                    });
                }
            });
            $('.sit').click(function(){
                var posisi = $(this).attr('data-index');
                if (checkSitAvailable(parseInt(posisi))) {
                    firebase.database().ref('games/player/'+me).update({
                        sitno:posisi,
                        status:'waiting'
                    });
                }else{
                    swal("Oops", "Kursi ini udh ada yg nempatin woyyy!" , "error");
                }
            });
            $('body').on('click','#btn-keluar',function(){
                firebase.database().ref('games/player/'+me).remove(function(){
                    deleteCookie('userlogin');
                    window.location = 'index.html';
                }).then(function(){
                    firebase.database().ref('games').once('value').then(function(response){
                        if (response.val().giliran == me) {                            
                            changeGiliran();
                        }
                    });                    
                });
            });
            $('body').on('click','#btn-standup',function(){
                firebase.database().ref('games/player/'+me).update({
                    sitno:0,
                    card:'[]',
                    status:0
                }).then(function(){
                    firebase.database().ref('games').once('value').then(function(response){
                        if (response.val().giliran == me) {                            
                            changeGiliran();
                        }
                    });
                });
            });

            $('body').on('click','#btn-send',function(){
                firebase.database().ref('games').once('value').then(function(response){
                    // for development
                    if (environment == 'development') {                        
                        me = response.val().giliran;
                    }
                    console.log('cardSelected',cardSelected);
                    if (checkGiliran()) {
                        if (validasi(cardSelected, JSON.parse(response.val().tablecard))) {
                            firebase.database().ref('games').update({
                                tablecard:JSON.stringify(cardSelected)
                            }).then(function(){
                                $.each(cardSelected, function(index, value) {
                                    remove(myCard, value);
                                });
                                firebase.database().ref('games/player/'+me).update({
                                    card:JSON.stringify(myCard)
                                }).then(function(){   
                                    if (response.val().warisan && response.val().warisan != 0 && typeof response.val().warisan != 'undefined') {
                                        firebase.database().ref('games').update({
                                            warisan:0
                                        });                                
                                    }
                                    if (myCard.length == 0) {
                                        firebase.database().ref('games/player/'+me).update({
                                            status:'winner'
                                        }).then(function(){
                                            setWarisan(me);
                                            if (response.val().winner == 0 || typeof response.val().winner === 'undefined') {
                                                firebase.database().ref('games').update({
                                                    winner:me
                                                });                                
                                            }
                                        });
                                    }                            
                                    changeGiliran();
                                    cardSelected = [];
                                });                    
                            });                    
                        }else{
                            swal("Oops", "GAK BISAAA WOYYY!" , "error");
                        }
                    }else{
                        swal("Oops", "Bukan giliran lu coy!" , "error");
                    }
                });
            });            
            $('body').on('click','#btn-pas',function(){
                firebase.database().ref('games').once('value').then(function(response){
                    // for development
                    if (environment == 'development') {                        
                        me = response.val().giliran;
                    }
                    console.log(me);
                    if (checkGiliran()) {
                        firebase.database().ref('games/player/'+me).update({
                            status: 'pas'
                        }).then(function(){
                            changeGiliran();
                        });
                    }else{
                        swal("Oops", "Bukan giliran lu coy!" , "error");
                    }
                });
            });            
            $('body').on('click','.kartu',function(){
                cardSelected = [];
                $(this).toggleClass('active');
                $.each($('body').find('.kartu.active'), function(index, value) {
                    cardSelected.push(parseInt(value.getAttribute('data-value')));
                });
                console.log(cardSelected);
            });
        </script>
    </body>
</html>