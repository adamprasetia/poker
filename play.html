<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Poker</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <link rel="stylesheet" href="assets/css/style.css">
    </head>
    <body>
        <img src="assets/img/poker_table_green.png" alt="">
        <div id="tablecard">
            
        </div>
        <div class="tablesit" style="display:none">     
            <div class="sit-1 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="1">
                    Duduk
                </a>
            </div>       
            <div class="sit-2 sitwrap">
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="2">
                    Duduk
                </a>
            </div>       
            <div class="sit-3 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="3">
                    Duduk
                </a>
            </div>       
            <div class="sit-4 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="4">
                    Duduk
                </a>
            </div>       
            <div class="sit-5 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="5">
                    Duduk
                </a>
            </div>       
            <div class="sit-6 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="6">
                    Duduk
                </a>
            </div>       
            <div class="sit-7 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="7">
                    Duduk
                </a>
            </div>       
            <div class="sit-8 sitwrap">                
                <a href="javascript:void(0)" class="sit btn btn-sm btn-secondary" data-index="8">
                    Duduk
                </a>
            </div>       
        </div>
        <div class="playersit">
        </div>
        
        <div class="button">            
            <button id="btn-pas" type="button" name="button" class="btn btn-sm btn-warning">Pas</button>
            <button id="btn-send" type="button" name="button" class="btn btn-sm btn-success">Send</button>
        </div>
        <div class="button-close">
            <button id="btn-keluar" type="button" name="button" class="btn btn-sm btn-danger">Keluar</button>
            <button id="btn-standup" type="button" name="button" class="btn btn-sm btn-danger">Stand Up</button>
        </div>
        
        <script type="text/javascript" src="http://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
        <script src="assets/js/config.js"></script>
        <script src="assets/js/helper.js"></script>
        <script type="text/javascript">
            var userlogin = JSON.parse(getCookie("userlogin"));
            var me = userlogin.username;
            var cardSelected = [];
            var myCard;

            if (!getCookie('userlogin')) {
                window.location = 'index.html';
            }        
            
            function checkSitAvailable(sitno = 0) {
                var status = true;
                firebase.database().ref('games/player').once('value', function(response) {
                    if (response.val()) {
                        $.each(response.val(), function(index, value) {
                            if (parseInt(value.sitno) == sitno) {
                                status = false;
                                return false;
                            }
                            tablecard += '<img class="card img-thumbnail" src="assets/img/'+value+'.png">';
                        });                        
                    }
                });
                return status;
            }
            function checkGiliran(){
                var status = false;
                firebase.database().ref('games/giliran').once('value', function(response) {
                    if (response.val() == me) {
                        status = true;
                    }
                });
                return status;
            }            
            function getPlayerBySit(player,sitno){
                var status = false;
                $.each(player, function(index, value) {
                    if (parseInt(value.sitno) == sitno) {
                        status = value;
                        return false;
                    }
                });                    
                return status;
            }
            function getCountPlay(player){
                var total = 0;
                $.each(player, function(index, value) {
                    if (value.status == 'play') {
                        total += 1;
                    }
                });
                return total;
            }
            function changeGiliran(){
                console.log('changeGiliran');
                firebase.database().ref('games').once('value', function(response) {                                    
                    var sitno = response.val().player[response.val().giliran].sitno;
                    if (sitno == 8) {
                        sitno = 1;
                    }else{
                        sitno++;
                    }                
                    for (var i = 1; i <= 8; i++) {
                        playerBySit = getPlayerBySit(response.val().player, sitno);
                        if (playerBySit.status && playerBySit.status == 'play') {
                            firebase.database().ref('games').update({
                                giliran:playerBySit.name
                            }).then(function(){
                                if (getCountPlay(response.val().player) == 1) {
                                    setPlayAll(response.val().player);
                                }
                            });
                            break;
                        }
                        if (sitno == 8) {
                            sitno = 1;
                        }else{
                            sitno++;
                        }
                    }
                });
            }
            function setGiliran(player, winner = ''){
                if (winner == '') {                    
                    var sitno = 1;
                    for (var i = 1; i <= 8; i++) {
                        playerBySit = getPlayerBySit(player, sitno);
                        if (parseInt(playerBySit.sitno) == sitno) {
                            firebase.database().ref('games').update({
                                giliran:playerBySit.name
                            });
                            break;
                        }
                        if (sitno == 8) {
                            sitno = 1;
                        }else{
                            sitno++;
                        }
                    }
                }else{
                    firebase.database().ref('games').update({
                        giliran:winner
                    });                    
                }
            }            
            function totalPlayer(player){
                var total = 0;
                $.each(player, function(index, value) {
                    if (value.sitno && value.sitno != 0) {                            
                        total += 1;
                    }
                });
                return total;
            }            
            function resetGame(winner = ''){
                console.log('resetGame', winner);
                firebase.database().ref('games').once('value').then(function(response){
                    var config_total_player = totalPlayer(response.val().player);
                    var config_total_kartu = 52;
                    var kartu = new Array(config_total_kartu);
                    for (var i = 0; i < kartu.length; i++) {
                        kartu[i] = i;
                    }
                    kartu = shuffle(kartu);
                    var playerCard = new Array(config_total_player);
                    for (var i = 0; i < config_total_player; i++) {
                        playerCard[i] = [];
                    }
                    $.each(kartu, function(index, value) {
                        playerCard[index % config_total_player].push(value);
                    });
                    
                    var i = 0;
                    $.each(response.val().player, function(index, value) {
                        if (value.sitno && value.sitno != 0 && totalPlayer(response.val().player) > 1) {                            
                            firebase.database().ref('games/player/'+index).update({                 
                                card: JSON.stringify(playerCard[i]),
                                status: 'play'
                            });                   
                            i++;
                        }else{
                            firebase.database().ref('games/player/'+index).update({                 
                                card: '[]',
                                status: 0
                            });                                               
                        }
                    });
                    
                    if (winner == '') {                        
                        setGiliran(response.val().player);
                    }else{
                        setGiliran(response.val().player, winner);
                    }
                    firebase.database().ref('games').update({
                        tablecard:"[]",
                        winner:0
                    });        
                    
                });                
            }
            function setPlayAll(player){
                $.each(player, function(index, value) {
                    if (value.status != 'winner' && value.card != '[]' && typeof value.card !== 'undefined') {
                        firebase.database().ref('games/player/'+value.name).update({
                            status:'play'
                        }).then(function(){
                            firebase.database().ref('games').update({
                                tablecard:'[]'
                            });
                        });
                    }
                });
            }
            function checkReset(player, winner = ''){
                console.log('checkReset');
                var total = 0;
                var totalSit = 0;
                var totalWinner = 0;
                $.each(player, function(index, value) {
                    console.log(value.card);
                    if (value.card != '[]' && typeof value.card !== 'undefined') {
                        total += 1;
                    }
                    if (value.sitno && value.sitno != 0) {
                        totalSit += 1;
                    }
                    if (value.status == 'winner') {
                        totalWinner += 1;
                    }
                });
                console.log('total', total);
                console.log('totalSit', totalSit);
                if (totalSit==1) {
                    resetGame();
                }
                if (totalSit > 1 && total == 1) {
                    swal("Info", "Bersiap, Permainan Akan Dimulai Kembali" , "info");
                    setTimeout(function(){
                        resetGame(winner);
                    }, 3000);                
                }
                if (totalSit > 1 && total == 0) {
                    swal("Info", "Bersiap, Permainan Akan Dimulai" , "info");
                    setTimeout(function(){
                        resetGame(winner);
                    }, 3000);
                }
            }
            firebase.database().ref('games').on('value', function(response) {
                var winner = '';
                if (response.val().winner != 0 || typeof response.val().winner != 'undefined') {                    
                    winner = response.val().winner;
                }
                checkReset(response.val().player, winner);
                // show tablecard
                if (response.val().tablecard) {
                    var tablecard = '';
                    $.each(JSON.parse(response.val().tablecard), function(index, value) {
                        tablecard += '<img class="card img-thumbnail" src="assets/img/'+value+'.png">';
                    });
                    $('#tablecard').html(tablecard);
                }
                // show player
                if (response.val().player) {
                    $('.playersit').html('');
                    $('.tablesit').show();
                    $('.tablesit > .sitwrap').show();
                    $('#btn-standup').prop('disabled', true);
                    $.each(response.val().player, function(indexPlayer, valuePlayer) {
                        var giliran = 'badge-secondary';
                        if (response.val().giliran == valuePlayer.name) {
                            giliran = 'badge-warning';
                        }
                        var playercard = '<div class="playercard">';
                        if (valuePlayer.card) {    
                            $.each(JSON.parse(valuePlayer.card).sort(function(a, b){return a - b}), function(indexCard, valueCard) {
                                if (valuePlayer.name == me) {  
                                    myCard = JSON.parse(valuePlayer.card);
                                    playercard += '<a href="javascript:void(0)" class="kartu" data-index="'+indexCard+'" data-value="'+valueCard+'"><img class="card img-thumbnail" src="assets/img/'+valueCard+'.png"></a>';
                                }else{                                    
                                    playercard += '<img class="card img-thumbnail" src="assets/img/back.png">';
                                }
                            });
                        }
                        playercard += '</div>';
                        if (valuePlayer.sitno) {         
                            $('.tablesit > .sit-'+valuePlayer.sitno).hide();
                            $('.playersit').append('<div class="sit-'+valuePlayer.sitno+' sitwrap"><span class="badge '+giliran+'">'+valuePlayer.name+'</span>'+playercard+'</div>');
                        }
                        if (valuePlayer.name == me && valuePlayer.sitno && valuePlayer.sitno != 0) {
                            $('.tablesit').hide();
                            $('#btn-standup').prop('disabled', false);
                        }
                    });
                }
            });
            $('.sit').click(function(){
                var posisi = $(this).attr('data-index');
                if (checkSitAvailable(parseInt(posisi))) {
                    firebase.database().ref('games/player/'+me).update({
                        sitno:posisi
                    });
                }else{
                    swal("Oops", "Kursi ini udh ada yg nempatin woyyy!" , "error");
                }
            });
            $('body').on('click','#btn-keluar',function(){
                firebase.database().ref('games/player/'+me).remove(function(){
                    deleteCookie('userlogin');
                    window.location = 'index.html';
                });
            });
            $('body').on('click','#btn-standup',function(){
                firebase.database().ref('games/player/'+me).update({
                    sitno:0,
                    card:'[]',
                    status:0
                }).then(function(){
                    changeGiliran();
                });
            });

            function checkStraight(cardSelected){
                var cardStraight = [];
                $.each(cardSelected, function(index, value) {
                    cardStraight.push((value - (value % 4)) / 4);
                });
                cardStraight.sort(function(a,b){return a-b});
                var a = -1, b = true;
                $.each(cardStraight, function(index, value) {
                    if (a == -1) {
                        a = value;
                    }else{
                        if (value-1 == a) {
                            a = value;
                        }else{
                            b = false;
                            return false;
                        }
                    }
                });
                return b;
            }
            function checkFlush(cardSelected){
                var cardFlush = [];
                var uniqueCardFlush = [];
                $.each(cardSelected, function(index, value) {
                    cardFlush.push(value % 4);
                });
                $.each(cardFlush, function(index, value){
                    if($.inArray(value, uniqueCardFlush) === -1) uniqueCardFlush.push(value);
                });                
                if (uniqueCardFlush.length == 1) {
                    return true;
                }
                return false;
            }
            function checkFullHouse(cardSelected){
                var cardFullHouse = [];
                var uniqueCardFullHouse = [];
                $.each(cardSelected, function(index, value) {
                    cardFullHouse.push((value - (value % 4)) / 4);
                });                
                $.each(cardFullHouse, function(index, value){
                    if($.inArray(value, uniqueCardFullHouse) === -1) uniqueCardFullHouse.push(value);
                });
                console.log(uniqueCardFullHouse);
                if (uniqueCardFullHouse.length == 2) {
                    var a = uniqueCardFullHouse[0];
                    var b = uniqueCardFullHouse[1];
                    var aa = 0;
                    var bb = 0;
                    var big = 0;
                    $.each(cardFullHouse, function(index, value){
                        if (a == value) {
                            aa += 1; 
                        }
                        if (b == value) {
                            bb += 1;
                        } 
                    });
                    if ((aa == 3 && bb == 2) || (aa == 2 && bb == 3)) {
                        if (aa > bb) {
                            big = a;
                        }else{
                            big = b;
                        }
                        return {'big':big, 'status':true};
                    }
                    return {'big':big, 'status':false};
                }else{
                    return {'big':big, 'status':false};
                }               
            }
            function validasi(cardSelected, card_on_arena){
                // validasi jumlah kartu
                if (cardSelected.length != card_on_arena.length && card_on_arena.length != 0) {
                    return false;
                }
                
                // validasi single
                if (cardSelected.length == 1 && cardSelected[0] < card_on_arena[0]) {
                    return false;
                }
                // validasi pair
                if (cardSelected.length > 1 && cardSelected.length < 5) {
                    var valid = true;
                    $.each(cardSelected, function(index, value) {
                        if (((value-(value%4))/4) != ((cardSelected[0]-(cardSelected[0]%4))/4)) {
                            valid = false;
                            return false;
                        }                   
                    });
                    if (!valid) {
                        return false;
                    }
                    if (Math.max(...cardSelected) < Math.max(...card_on_arena)) {
                        return false;
                    }
                }
                // validasi 5 card
                if (cardSelected.length == 5) {
                    if (checkFullHouse(cardSelected).status) {
                        console.log('full house');                        
                        if (card_on_arena.length != 0) {
                            if (checkFullHouse(card_on_arena).status) {
                                console.log(checkFullHouse(cardSelected).big, checkFullHouse(card_on_arena).big);
                                if (checkFullHouse(cardSelected).big < checkFullHouse(card_on_arena).big) {
                                    return false;
                                }
                            }else{
                                return false;
                            }
                        }
                    }else if (checkFlush(cardSelected) && checkStraight(cardSelected)) {
                        console.log('straight flush');
                        if (card_on_arena.length != 0) {
                            if ((checkFlush(card_on_arena) && checkStraight(card_on_arena)) || checkStraight(card_on_arena) || checkFlush(card_on_arena)) {
                                if (Math.max(...cardSelected) < Math.max(...card_on_arena)) {
                                    return false;
                                }                                
                            }else{
                                return false;
                            }
                        }
                    }else if (checkFlush(cardSelected)) {
                        console.log('flush');    
                        if (card_on_arena.length != 0) {                            
                            if (checkFlush(card_on_arena) && !checkStraight(card_on_arena)) {
                                if (Math.max(...cardSelected) < Math.max(...card_on_arena)) {
                                    return false;
                                }                                
                            }else{
                                return false;
                            }
                        }                    
                    }else if (checkStraight(cardSelected)) {                        
                        console.log('straight');
                        if (card_on_arena.length != 0) {                            
                            if (checkStraight(card_on_arena) && !checkFlush(card_on_arena)) {
                                if (Math.max(...cardSelected) < Math.max(...card_on_arena)) {
                                    return false;
                                }                                
                            }else{
                                return false;
                            }
                        }
                    }else{
                        console.log('not match');
                        return false;
                    }
                }
                
                return true;
            }
            
            $('body').on('click','#btn-send',function(){
                firebase.database().ref('games').once('value').then(function(response){
                    if (checkGiliran()) {
                        if (validasi(cardSelected, JSON.parse(response.val().tablecard))) {
                            firebase.database().ref('games').update({
                                tablecard:JSON.stringify(cardSelected)
                            }).then(function(){
                                $.each(cardSelected, function(index, value) {
                                    remove(myCard, value);
                                });
                                firebase.database().ref('games/player/'+me).update({
                                    card:JSON.stringify(myCard)
                                }).then(function(){   
                                    if (myCard.length == 0) {
                                        firebase.database().ref('games/player/'+me).update({
                                            status:'winner'
                                        });
                                    }                            
                                    firebase.database().ref('games').once('value', function(response) {                                
                                        if (!response.val().winner || typeof response.val().winner == 'undefined') {
                                            firebase.database().ref('games').update({
                                                winner:me
                                            });                                
                                        }
                                    });
                                    changeGiliran();
                                    cardSelected = [];
                                });                    
                            });                    
                        }else{
                            swal("Oops", "GAK BISAAA WOYYY!" , "error");
                        }
                    }else{
                        swal("Oops", "Bukan giliran lu coy!" , "error");
                    }
                });
            });            
            $('body').on('click','#btn-pas',function(){
                if (checkGiliran()) {
                    firebase.database().ref('games/player/'+me).update({
                        status: 'pas'
                    }).then(function(){
                        changeGiliran();
                    });
                }else{
                    swal("Oops", "Bukan giliran lu coy!" , "error");
                }
            });            
            $('body').on('click','.kartu',function(){
                var value = parseInt($(this).attr('data-value'));
                if ($(this).hasClass('active')) {
                    $(this).removeClass('active');
                    remove(cardSelected, value);
                }else{      
                    if (cardSelected.length < 5) {
                        $(this).addClass('active');
                        cardSelected.push(value);
                    }
                }
                console.log(cardSelected);
            });
        </script>
    </body>
</html>